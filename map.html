<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css">
    <!-- <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
        width: 80%;
        margin-right: 0;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style> -->
  </head>
  <body>
    <div class="app">
      <div class="listBlock">
        <h2>Список приходских сел</h2>
        <ul class="list">
          <li class="listItem" v-for="location in data.locations">
            {{location.name}}
          </li>
          <!-- <li class="listItem">
            Туваны
          </li>
          <li class="listItem">
            Ходары
          </li>
          <li class="listItem">
            Штанаши
          </li>
          <li class="listItem">
            Раскильдино
          </li> -->
        </ul>
      </div>
      <div id="map"></div>
    </div>
    <script>
      var map;
      var markers = [];
      var marker;

      function initMap() {
        // var pos = {lat: 55.488290, lng: 47.328645};

        // var churchIcon = {
        //   path: 'M 125,5 155,90 245,90 175,145 200,230 125,180 50,230 75,145 5,90 95,90 z',
        //   fillColor: 'yellow',
        //   fillOpacity: 0.8,
        //   scale: 1,
        //   strokeColor: 'gold',
        //   strokeWeight: 14
        // }
        //
        // var image = {
        //   // url: 'img/christian.svg',
        //   url: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png',
        //   // This marker is 20 pixels wide by 32 pixels high.
        //   size: new google.maps.Size(20, 32),
        //   // The origin for this image is (0, 0).
        //   origin: new google.maps.Point(0, 0),
        //   // The anchor for this image is the base of the flagpole at (0, 32).
        //   anchor: new google.maps.Point(0, 32)
        // };

        var opt = {
          // center: {lat: data.pos[0], lng: data.pos[1]},
          center: {lat: 54.325782, lng: 48.392605},
          zoom: 6,
          mapTypeId: 'roadmap'
        };

        var map = new google.maps.Map(document.getElementById('map'), opt);

        var marker, i, coord;
        // for (i = 0; i < locations.length; i++) {
        //   coord = locations[i];
        //   marker = new google.maps.Marker({
        //     position: new google.maps.LatLng(coord.pos[0], coord.pos[1]),
        //     map: map
        //   });
        //
        //   google.maps.event.addListener(marker, 'click', (function(marker, i) {
        //     return function() {
        //       infoWindow.setContent(locations[i].name + " " + locations[i].info);
        //
        //       infoWindow.open(map, marker);
        //
        //     }
        //   })(marker, i));
        // }


        var contentString;
        markers = data.locations.map(function(location, i) {
          return new google.maps.Marker({
            position: new google.maps.LatLng(location.pos[0], location.pos[1]),
            // label: location.name
          })
        });
        console.log(markers);

        for (var i = 0; i < markers.length; i++) {
          console.log(markers[i]);
        }

        var infowindow = new google.maps.InfoWindow({
          // content: contentString
        });
        // //


        // function adding(marker, info)
        for (let i = 0; i < markers.length; i++) {
          markers[i].addListener('click', function () {
            infowindow.setContent(
              '<h3>' + data.locations[i].name + '</h3>' +
              '<h4>' + data.locations[i].church + '</h4>' +
              '<p>' + data.locations[i].info + '</p>' +
              '<a href="' + data.locations[i].link + '" target="_blank">' + 'Источник</a>'
            );
            infowindow.setPosition({
              lat: data.locations[i].pos[0],
              lng: data.locations[i].pos[1]
            });
            infowindow.open(map, markers[i]);
            // currentString = data.locations[i].name
            // console.log(data.locations[i].name)
          })
        }
        //
        // google.maps.event.addListener(marker, 'click', function (currentMarker, currentInfoWindow) {
        //
        //   return function () {
        //     currentInfoWindow.open(map, currentMarker);
        //   }
        // }(marker, infoWindow));

        //
        // for (var j = 0; j < markers.length; j++) {
        //   debugger;
        //   marker = markers[j];
        //   marker.addListener('click', function () {
        //     console.log(data.locations[j].name);
        //     // contentString = "hello";
        //     // infowindow.open(map, markers[j])
        //   })
        // };
        //
        // for (var i = 0; i < markers.length; i++) {
        //   google.maps.event.addListener(marker, 'click', (function (marker, i) {
        //     return function() {
        //       infoWindow.setContent(data.locations[i].name + " " + data.locations[i].info);
        //       infoWindow.open(map, marker);
        //     }
        //   })(marker, i));
        // };
        //
        // for (var i = 0; i < markers.length; i++) {
        //   google.maps.event.addListener(marker, 'click', (function(marker, i) {
        //     return function() {
        //       infoWindow.setContent(data.locations[i].name + " " + data.locations[i].info);
        //
        //       infoWindow.open(map, marker);
        //
        //     }
        //   })(marker, i));
        // }

        var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
        // var marker

        //
        // var marker = new google.maps.Marker({
        //   position: opt.center,
        //   map: map,
        //   title: data.name,
        //   // icon: churchIcon,
        //   position: map.getCenter()
        // });
        var infoWindow = new google.maps.InfoWindow({
          // content: "Hello"
        });
        //
        // marker.addListener('click', function () {
        //   debugger;
        //   info.open(map, marker);
        // })



        // Определение местоположения
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            //
            // infoWindow.setPosition(pos);
            // infoWindow.setContent('Location found.');
            // infoWindow.open(map);
            map.setCenter(pos);
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }
    </script>
    <script type="text/javascript" src="backend/data.json"></script>
    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAj5OoXtT1Nv-OcRnLLT5b4VZiqGnqxFU4&callback=initMap" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.0"></script>
    <script src="script/script.js" type="text/javascript"></script>
  </body>
</html>
